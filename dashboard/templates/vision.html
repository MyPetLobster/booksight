{% extends "layout.html" %}
{% load static %}

{% block title %}Booksight{% endblock %}
{% block body %}
    <div class="page-identifier" style="display:none">vision</div>
    <div class="idx-content">
        <div class="landing-logo-div-vision">
            <img id="logo-eyes-vision" src="{% static 'dashboard/images/eyes-only.png' %}" alt="Booksight Logo Owl Eyes">
            <img id="logo-text-vision" src="{% static 'dashboard/images/booksight-text.png' %}" alt="Booksight Logo Text">
        </div>
        </br>
            <div id="image-div">
                <img class="proc-upload-img" id="uploaded-image-raw" src="{{ image_path }}" alt="Uploaded Image" style="max-width: 350px; max-height: 500px; display: block">
                <div class="spine-image-grid" id="spine-image-grid"></div>
            </div>
        </br>
        <div class="vision-para-div">
            <p>
                Your image is processing. Once complete, you will receive an email with a file in the format you specified.
            </p>
            <p>
                If you want to see the process in detail, you can visit the <a class="vision-link" href="https://github.com/MyPetLobster/booksight">Booksight GitHub repository</a> to download the project and 
                run the terminal-based version of the Vision application to see the process in action.
            </p>
            <p>
                <a class="vision-link" href="{% url 'index' %}">Return to the home page</a>
            </p>
        </div>
    </div>

<script>
function checkStatus() {
    $.ajax ({
        url: "{% url 'vision_status' %}",
        type: "GET",
        success: function(data) {
            console.log(data.status);
            if (data.status == "bbox-detected" && document.getElementById("bbox-image") == null){
                // Create a new image element to display the bounding box image
                const bbox_image_element = document.createElement("img");
                bbox_image_element.id = "bbox-image";
                bbox_image_element.src = data.bbox_image;
                bbox_image_element.style.display = "block";
                bbox_image_element.style.maxWidth = "500px";
                bbox_image_element.style.maxHeight = "700px";
                document.getElementById("image-div").appendChild(bbox_image_element);

                // Hide the uploaded image
                const uploaded_image_element = document.getElementById("uploaded-image-raw");
                uploaded_image_element.style.display = "none";
                bbox_image_element.src = data.bbox_image;
                bbox_image_element.style.display = "block";

                console.log(`Bounding box detected: ${data.bbox_image}`)

            } else if (data.status == "text-detected") {
                // Hide bbox image
                const bbox_image_element = document.getElementById("bbox-image");
                bbox_image_element.style.display = "none";

                // Create a new image elements to display the text images
                for (var i = 0; i < data.text_images.length; i++) {
                    var spine_image = $("<img>").attr("src", data.text_images[i]);
                    spine_image.attr("class", "proc-upload-img");
                    spine_image.attr("style", "max-width: 200px; max-height: 350px; display: block");
                    $("#spine-image-grid").append(spine_image);
                }
            } else if (data.status == "completed") {
                clearInterval(statusInterval);
                window.location.href = "{% url 'vision_complete' %}";
            } else {
                setTimeout(checkStatus, 10000);
            }
        }
    });
}

var statusInterval = setInterval(checkStatus, 10000);
</script>

{% endblock %}


