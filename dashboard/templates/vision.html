{% extends "layout.html" %}
{% load static %}

{% block title %}Booksight{% endblock %}
{% block body %}
    <div class="page-identifier" style="display:none">vision</div>
    <div id="full-size-image-div"></div>
    <div class="vis-content">

        <div class="landing-logo-div-vision">
            <img id="logo-eyes-vision" src="{% static 'dashboard/images/eyes-only.png' %}" alt="Booksight Logo Owl Eyes">
            <img id="logo-text-vision" src="{% static 'dashboard/images/booksight-text.png' %}" alt="Booksight Logo Text">
        </div>
        </br>
            <div id="progress-status"></div>
            <div id="image-div">
                <img class="proc-upload-img uploaded-image" id="uploaded-image-raw" src="{{ image_path }}" alt="Uploaded Image">
            </div>
        </br>
        <div class="vision-para-div">
            <p>
                Your image is processing. Once complete, you will receive an email with a file in the format you specified.
            </p>
            <p>
                If you want to see the process in detail, you can visit the <a class="vision-link" href="https://github.com/MyPetLobster/booksight">Booksight GitHub repository</a> to download the project and 
                run the terminal-based version of the Vision application to see the process in action.
            </p>
            <p>
                <a class="vision-link" href="{% url 'index' %}">Return to the home page</a>
            </p>
        </div>
    </div>

<script>

let stage_three_started = false;
let stage_four_started = false;

function checkStatus() {
    $.ajax ({
        url: "{% url 'vision_status' %}",
        type: "GET",
        success: function(data) {
            console.log(data.status);
            if (data.status == "bbox-detected" && document.getElementById("bbox-image") == null) {
                // Create a new image element to display the bounding box image
                const bbox_image_element = document.createElement("img");
                bbox_image_element.id = "bbox-image";
                bbox_image_element.src = data.bbox_image;
                bbox_image_element.className = "proc-upload-img bbox-image";
                bbox_image_element.style.display = "block";
                document.getElementById("image-div").appendChild(bbox_image_element);

                // Hide the uploaded image
                const uploaded_image_element = document.getElementById("uploaded-image-raw");
                uploaded_image_element.style.display = "none";

                // Update status
                updateStatusStageTwo();

                console.log(`Bounding box detected: ${data.bbox_image}`)

            } else if (data.status == "text-detected" && document.getElementById("spine-image-grid") == null) {
                // Hide bbox image
                const bbox_image_element = document.getElementById("bbox-image");
                bbox_image_element.style.display = "none";
                
                // Create a new div within image-div to display the text detection images in a grid
                const spine_image_grid = document.createElement("div");
                spine_image_grid.id = "spine-image-grid";
                spine_image_grid.classList.add("spine-image-grid");
                document.getElementById("image-div").appendChild(spine_image_grid);

                // Create new image elements to display the text images
                const text_images = data.text_images.split(",");
                for (let i = 0; i < text_images.length; i++) {
                    const text_image_element = document.createElement("img");
                    text_image_element.src = text_images[i];
                    text_image_element.className = "spine-grid-element";
                    spine_image_grid.appendChild(text_image_element);

                    // create full size image hidden until clicked
                    const full_size_image = document.createElement("img");
                    document.getElementById("full-size-image-div").appendChild(full_size_image);
                    full_size_image.src = text_images[i];
                    full_size_image.className = "full-size-image";
                    full_size_image.style.display = "none";

                    // add click event to show full size image
                    text_image_element.addEventListener("click", function() {
                        // if theres already a full size image, hide it
                        const full_size_images = document.getElementsByClassName("full-size-image");
                        for (let i = 0; i < full_size_images.length; i++) {
                            full_size_images[i].style.display = "none";
                        }

                        full_size_image.style.display = "block";

                        // add click event to hide full size image if anywhere on the page is clicked
                        full_size_image.addEventListener("click", function() {
                            full_size_image.style.display = "none";
                        });

                    });

                }

                // Update status
                if (!stage_three_started) {
                    updateStatusStageThree();
                }
            } else if (data.status == "ai-complete") {
                // Update status
                if (!stage_four_started) {
                    updateStatusStageFour();
                }
            } else if (data.status == "completed") {
                clearInterval(statusInterval);
                window.location.href = "{% url 'vision_complete' %}";
            } else {
                setTimeout(checkStatus, 5000);
            }
        }
    });
}

function updateStatus() {
    // Change status every 1.5 seconds
    var status = document.getElementById("progress-status");
    const start_time = new Date().getTime();
    var status_text = ["Loading image...", "Enhancing image...", "Saving enhanced image...", "Applying tensor transformation...", "Running object detection...", "Drawing bounding boxes and creating new spine images..."];

    var i = 0;
    var interval = setInterval(function() {
        status.innerHTML = status_text[i];
        i++;
        if (i == status_text.length) {
            clearInterval(interval);
        }
    }, 1000);
}

function updateStatusStageTwo() {
    // Change status every 1.5 seconds
    var status = document.getElementById("progress-status");
    const start_time = new Date().getTime();
    var status_text = ["Analyzing image and spine objects...", "Beginning text detection using EasyOCR...", "This process may take a minute...", "...or two...", "Almost there. I can feel it..."];

    var i = 0;
    var interval = setInterval(function() {
        status.innerHTML = status_text[i];
        i++;
        if (i == status_text.length) {
            clearInterval(interval);
        }
    }, 7000);
}

function updateStatusStageThree() {
    stage_three_started = true;
    var status = document.getElementById("progress-status");
    status.innerHTML = "All image processing and OCR operations complete. Beginning book identification...";
    var status_text = ["Preparing text for AI input and running AI model..."]
    
    var i = 0;
    var interval = setInterval(function() {
        status.innerHTML = status_text[i];
        i++;
        if (i == status_text.length) {
            clearInterval(interval);
        }
    }, 3500);
}

function updateStatusStageFour() {
    stage_four_started = true;
    var status = document.getElementById("progress-status");
    status.innerHTML = "AI model complete. Processing results...";
    var status_text = ["Beginning book matching processes, using Google Books, ISBNdb, and Open Library APIs...", "This process may take several minutes...", "This process is probably gonna take a while...", "[awkward eye contact]...shouldn't be too much longer...", "ðŸŽ¶<em>elevator music</em>ðŸŽ¶", "Sooo...how's life treating you?", "Why did the data analyst go to the zoo?", "To see the pandas!", "Ok I've got nothing else...it'll be done soon I swear"];
    
    var i = 0;
    var interval = setInterval(function() {
        status.innerHTML = status_text[i];
        i++;
        if (i == status_text.length) {
            clearInterval(interval);
        }
    }, 8000);

}


updateStatus();


var statusInterval = setInterval(checkStatus, 5000);
</script>

{% endblock %}
