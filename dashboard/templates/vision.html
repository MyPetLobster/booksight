{% extends "layout.html" %}
{% load static %}

{% block title %}Booksight{% endblock %}
{% block body %}
    <div class="page-identifier" style="display:none">vision</div>
    <div class="vis-content">
        <div class="landing-logo-div-vision">
            <img id="logo-eyes-vision" src="{% static 'dashboard/images/eyes-only.png' %}" alt="Booksight Logo Owl Eyes">
            <img id="logo-text-vision" src="{% static 'dashboard/images/booksight-text.png' %}" alt="Booksight Logo Text">
        </div>
        </br>
            <div id="image-div">
                <img class="proc-upload-img uploaded-image" id="uploaded-image-raw" src="{{ image_path }}" alt="Uploaded Image">
            </div>
        </br>
        <div class="vision-para-div">
            <p>
                Your image is processing. Once complete, you will receive an email with a file in the format you specified.
            </p>
            <p>
                If you want to see the process in detail, you can visit the <a class="vision-link" href="https://github.com/MyPetLobster/booksight">Booksight GitHub repository</a> to download the project and 
                run the terminal-based version of the Vision application to see the process in action.
            </p>
            <p>
                <a class="vision-link" href="{% url 'index' %}">Return to the home page</a>
            </p>
        </div>
    </div>

<script>
function checkStatus() {
    $.ajax ({
        url: "{% url 'vision_status' %}",
        type: "GET",
        success: function(data) {
            console.log(data.status);
            if (data.status == "bbox-detected" && document.getElementById("bbox-image") == null) {
                // Create a new image element to display the bounding box image
                const bbox_image_element = document.createElement("img");
                bbox_image_element.id = "bbox-image";
                bbox_image_element.src = data.bbox_image;
                bbox_image_element.className = "proc-upload-img bbox-image";
                bbox_image_element.style.display = "block";
                document.getElementById("image-div").appendChild(bbox_image_element);

                // Hide the uploaded image
                const uploaded_image_element = document.getElementById("uploaded-image-raw");
                uploaded_image_element.style.display = "none";

                console.log(`Bounding box detected: ${data.bbox_image}`)

            } else if (data.status == "text-detected" && document.getElementById("spine-image-grid") == null) {
                // Hide bbox image
                const bbox_image_element = document.getElementById("bbox-image");
                bbox_image_element.style.display = "none";
                
                // Create a new div within image-div to display the text detection images in a grid
                const spine_image_grid = document.createElement("div");
                spine_image_grid.id = "spine-image-grid";
                spine_image_grid.classList.add("spine-image-grid");
                document.getElementById("image-div").appendChild(spine_image_grid);

                // Create new image elements to display the text images
                const text_images = data.text_images.split(",");
                for (let i = 0; i < text_images.length; i++) {
                    const text_image_element = document.createElement("img");
                    text_image_element.src = text_images[i];
                    text_image_element.className = "spine-grid-element";
                    spine_image_grid.appendChild(text_image_element);
                }
            } else if (data.status == "completed") {
                clearInterval(statusInterval);
                window.location.href = "{% url 'vision_complete' %}";
            } else {
                setTimeout(checkStatus, 10000);
            }
        }
    });
}

var statusInterval = setInterval(checkStatus, 10000);
</script>

{% endblock %}
